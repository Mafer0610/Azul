<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles del Ni√±o</title>
    <link rel="stylesheet" href="../styles/stylesVerN.css" />
    <script>
        (function() {
            function checkAuth() {
                const isAuthenticated = localStorage.getItem('isAuthenticated');
                const loginTimestamp = localStorage.getItem('loginTimestamp');
                
                if (!isAuthenticated || isAuthenticated !== 'true') {
                    redirectToLogin();
                    return;
                }
                
                if (loginTimestamp) {
                    const currentTime = Date.now();
                    const loginTime = parseInt(loginTimestamp);
                    const eightHours = 8 * 60 * 60 * 1000;
                    
                    if (currentTime - loginTime > eightHours) {
                        localStorage.removeItem('isAuthenticated');
                        localStorage.removeItem('loginTimestamp');
                        alert('Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.');
                        redirectToLogin();
                        return;
                    }
                }
            }
            
            function redirectToLogin() {
                if (window.location.pathname.includes('index.html') || 
                    window.location.pathname === '/' || 
                    window.location.pathname.endsWith('/')) {
                    return;
                }
                
                window.location.replace('../index.html');
            }
            
            checkAuth();
            
            window.addEventListener('focus', checkAuth);
            
            setInterval(checkAuth, 5 * 60 * 1000);
        })();
    </script>
</head>
<body>
    <div class="container">
        <div class="detail-container">
            <div class="detail-header">
                <h1>Detalles del Ni√±o</h1>
                <p>Informaci√≥n completa del registro</p>
            </div>

            <!-- Loading State -->
            <div id="loadingDetail" class="loading-detail">
                <div class="loading-spinner" style="margin: 0 auto 15px;"></div>
                <p>Cargando informaci√≥n...</p>
            </div>

            <!-- Error State -->
            <div id="errorDetail" class="error-detail" style="display: none;">
                <h3>‚ùå Error</h3>
                <p id="errorMessage">No se pudo cargar la informaci√≥n del ni√±o</p>
                <button class="btn btn-primary" onclick="retryLoad()">
                    üîÑ Reintentar
                </button>
            </div>

            <!-- Content -->
            <div id="detailContent" style="display: none;">
                <div class="detail-content">
                    <a href="javascript:history.back()" class="back-link">
                        ‚Üê Volver a la lista
                    </a>

                    <!-- Informaci√≥n Personal -->
                    <div class="detail-section">
                        <h3>üë§ Informaci√≥n Personal</h3>
                        <div class="detail-row">
                            <span class="detail-label">Nombre Completo:</span>
                            <span class="detail-value highlight" id="nombreCompleto">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Edad:</span>
                            <span class="detail-value" id="edad">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Diagn√≥stico:</span>
                            <span class="detail-value" id="comportamiento">-</span>
                        </div>
                    </div>

                    <!-- Informaci√≥n del Tutor -->
                    <div class="detail-section">
                        <h3>Informaci√≥n del Tutor</h3>
                        <div class="detail-row">
                            <span class="detail-label">Nombre del Tutor:</span>
                            <span class="detail-value highlight" id="nombreTutor">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Celular:</span>
                            <span class="detail-value" id="celularTutor">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Fecha de Pago:</span>
                            <span class="detail-value" id="fechaPago">-</span>
                        </div>
                    </div>

                    <!-- Caracter√≠sticas Especiales -->
                    <div class="detail-section">
                        <h3>üìù Caracter√≠sticas Especiales</h3>
                        <div class="caracteristicas-box" id="caracteristicas">
                            Sin caracter√≠sticas especiales registradas.
                        </div>
                    </div>

                    <!-- Informaci√≥n del Sistema -->
                    <div class="detail-section">
                        <h3>‚ÑπÔ∏è Informaci√≥n del Sistema</h3>
                        <div class="detail-row">
                            <span class="detail-label">Fecha de Registro:</span>
                            <span class="detail-value" id="fechaRegistro">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">ID del Sistema:</span>
                            <span class="detail-value" id="idSistema">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Estado:</span>
                            <span class="detail-value" id="estado">Activo</span>
                        </div>
                    </div>
                </div>

                <!-- Acciones -->
                <div class="actions-section">
                    <button class="btn btn-warning" onclick="editarPeque()">
                        ‚úèÔ∏è Editar Informaci√≥n
                    </button>
                    <button class="btn btn-danger" onclick="eliminarPeque()">
                        üóëÔ∏è Eliminar Registro
                    </button>
                    <button class="btn btn-success" onclick="contactarTutor()">
                        üìû Contactar Tutor
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPeque = null;
        let pequeId = null;

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            pequeId = urlParams.get('id');
            
            if (pequeId) {
                loadPequeDetails(pequeId);
            } else {
                showError('No se especific√≥ un ID de ni√±o v√°lido');
            }
        });

        async function loadPequeDetails(id) {
            showLoading(true);
            
            try {
                const response = await fetch(`http://localhost:5000/api/peques/${id}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('El ni√±o solicitado no fue encontrado');
                    }
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const peque = await response.json();
                currentPeque = peque;
                displayPequeDetails(peque);
                
            } catch (error) {
                console.error('Error cargando detalles:', error);
                showError(error.message);
            }
        }

        function displayPequeDetails(peque) {
            document.getElementById('nombreCompleto').textContent = peque.nombreCompleto || '-';
            document.getElementById('edad').textContent = peque.edad ? `${peque.edad} a√±os` : '-';
            
            const comportamientoEl = document.getElementById('comportamiento');
            if (peque.comportamiento) {
                comportamientoEl.innerHTML = `<span class="badge badge-${peque.comportamiento}">${peque.comportamiento}</span>`;
            } else {
                comportamientoEl.textContent = '-';
            }

            document.getElementById('nombreTutor').textContent = peque.nombreTutor || '-';
            document.getElementById('celularTutor').textContent = formatPhone(peque.celularTutor) || '-';
            
            document.getElementById('fechaPago').textContent = peque.fechaPago ? `D√≠a ${peque.fechaPago}` : '-';

            const caracteristicasEl = document.getElementById('caracteristicas');
            if (peque.caracteristicas && peque.caracteristicas.trim()) {
                caracteristicasEl.textContent = peque.caracteristicas;
            } else {
                caracteristicasEl.textContent = 'Sin caracter√≠sticas especiales registradas.';
                caracteristicasEl.style.fontStyle = 'italic';
                caracteristicasEl.style.color = '#6c757d';
            }

            document.getElementById('fechaRegistro').textContent = formatDate(peque.createdAt || peque.fechaRegistro);
            document.getElementById('idSistema').textContent = peque._id || '-';
            document.getElementById('estado').innerHTML = '<span class="badge badge-neurotipico">Activo</span>';

            document.title = `Detalles - ${peque.nombreCompleto}`;

            showContent();
        }

        function editarPeque() {
            if (currentPeque) {
                window.location.href = `editarN.html?id=${currentPeque._id}`;
            } else {
                alert('‚ùå No hay informaci√≥n del ni√±o para editar');
            }
        }

        async function eliminarPeque() {
            if (!currentPeque) return;
            
            const confirmMessage = `¬øEst√° seguro de que desea eliminar el registro de "${currentPeque.nombreCompleto}"?\n\nEsta acci√≥n no se puede deshacer y eliminar√° toda la informaci√≥n asociada.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5000/api/peques/${currentPeque._id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ ${data.message}`);
                    window.location.href = 'infant.html';
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error eliminando peque:', error);
                alert('‚ùå Error al conectar con el servidor');
            }
        }

        function contactarTutor() {
            if (currentPeque && currentPeque.celularTutor) {
                const phone = currentPeque.celularTutor.replace(/\D/g, '');
                const message = encodeURIComponent(`Hola ${currentPeque.nombreTutor}, me comunico con usted respecto a ${currentPeque.nombreCompleto}.`);
                const whatsappUrl = `https://wa.me/52${phone}?text=${message}`;
                window.open(whatsappUrl, '_blank');
            } else {
                alert('No hay n√∫mero de celular registrado para este tutor');
            }
        }

        function retryLoad() {
            if (pequeId) {
                loadPequeDetails(pequeId);
            }
        }

        function showLoading(show) {
            document.getElementById('loadingDetail').style.display = show ? 'block' : 'none';
            document.getElementById('detailContent').style.display = show ? 'none' : 'block';
            document.getElementById('errorDetail').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('loadingDetail').style.display = 'none';
            document.getElementById('detailContent').style.display = 'none';
            document.getElementById('errorDetail').style.display = 'block';
        }

        function showContent() {
            document.getElementById('loadingDetail').style.display = 'none';
            document.getElementById('errorDetail').style.display = 'none';
            document.getElementById('detailContent').style.display = 'block';
        }

        function formatPhone(phone) {
            if (phone && phone.length === 10) {
                return `(${phone.slice(0, 3)}) ${phone.slice(3, 6)}-${phone.slice(6)}`;
            }
            return phone;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            
            const date = new Date(dateString);
            return date.toLocaleDateString('es-MX', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
    </script>
</body>
</html>