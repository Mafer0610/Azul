<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Producto</title>
    <link rel="stylesheet" href="../styles/stylesEditarProducto.css" />
    <script>
        (function() {
            function checkAuth() {
                const isAuthenticated = localStorage.getItem('isAuthenticated');
                const loginTimestamp = localStorage.getItem('loginTimestamp');
                
                if (!isAuthenticated || isAuthenticated !== 'true') {
                    redirectToLogin();
                    return;
                }
                
                if (loginTimestamp) {
                    const currentTime = Date.now();
                    const loginTime = parseInt(loginTimestamp);
                    const eightHours = 8 * 60 * 60 * 1000;
                    
                    if (currentTime - loginTime > eightHours) {
                        localStorage.removeItem('isAuthenticated');
                        localStorage.removeItem('loginTimestamp');
                        alert('Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.');
                        redirectToLogin();
                        return;
                    }
                }
            }
            
            function redirectToLogin() {
                window.location.replace('../index.html');
            }
            
            checkAuth();
            window.addEventListener('focus', checkAuth);
            setInterval(checkAuth, 5 * 60 * 1000);
        })();
    </script>
</head>
<body>
    <div class="container">
        <div class="edit-container">
            <div class="edit-header">
                <h1>Editar Producto</h1>
                <p>Modifica los datos del producto</p>
            </div>

            <div id="loadingEdit" class="loading-edit">
                <div class="loading-spinner" style="margin: 0 auto 15px;"></div>
                <p>Cargando informaci√≥n para editar...</p>
            </div>

            <div id="errorEdit" class="error-edit" style="display: none;">
                <h3>Error</h3>
                <p id="errorEditMessage">No se pudo cargar la informaci√≥n</p>
                <button class="btn btn-primary" onclick="retryLoad()">
                    Reintentar
                </button>
            </div>

            <div id="editContent" style="display: none;">
                <form class="edit-form" id="editForm">
                    <a href="javascript:history.back()" class="back-link">
                        ‚Üê Volver a tienda
                    </a>

                    <div class="success-message" id="successMessage">
                        El producto se actualiz√≥ correctamente
                    </div>

                    <h3 style="color: #495057; margin-bottom: 20px; border-bottom: 2px solid #ffc107; padding-bottom: 10px;">
                        üõçÔ∏è Informaci√≥n del Producto
                    </h3>

                    <div class="form-group">
                        <label class="form-label" for="nombre">Nombre del Producto *</label>
                        <input type="text" class="form-control" id="nombre" name="nombre" required>
                        <div class="invalid-feedback">El nombre del producto es obligatorio</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="precio">Precio *</label>
                        <input type="number" class="form-control" id="precio" name="precio" step="0.01" min="0" required>
                        <div class="invalid-feedback">El precio es obligatorio y debe ser mayor a 0</div>
                    </div>


                    <div class="form-group">
                        <label class="form-label" for="cantidad">Cantidad Disponible</label>
                        <input type="number" class="form-control" id="cantidad" name="cantidad" min="0" placeholder="0">
                        <div class="invalid-feedback">La cantidad debe ser un n√∫mero positivo</div>
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label class="form-label" for="caracteristicas">Caracter√≠sticas</label>
                        <textarea class="form-control" id="caracteristicas" name="caracteristicas" rows="4" 
                                  placeholder="Describe el producto (opcional)"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="cancelarEdicion()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-warning" id="submitBtn">
                            Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentProducto = null;
        let productoId = null;

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            productoId = urlParams.get('id');
            
            if (productoId) {
                loadProductoForEdit(productoId);
            } else {
                showError('No se especific√≥ un ID de producto v√°lido');
            }

            document.getElementById('editForm').addEventListener('submit', handleSubmit);
        });

        async function loadProductoForEdit(id) {
            showLoading(true);
            
            try {
                const response = await fetch(`http://localhost:5000/api/productos/${id}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('El producto solicitado no fue encontrado');
                    }
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const producto = await response.json();
                currentProducto = producto;
                fillForm(producto);
                showContent();
                
            } catch (error) {
                console.error('Error cargando datos para edici√≥n:', error);
                showError(error.message);
            }
        }

        function fillForm(producto) {
            document.getElementById('nombre').value = producto.nombre || '';
            document.getElementById('precio').value = producto.precio || '';
            document.getElementById('cantidad').value = producto.cantidad || '';
            document.getElementById('caracteristicas').value = producto.caracteristicas || '';

            document.title = `Editar - ${producto.nombre}`;
        }

        async function handleSubmit(event) {
            event.preventDefault();
            
            if (!validateForm()) {
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Guardando...';

            try {
                const formData = {
                    nombre: document.getElementById('nombre').value.trim(),
                    precio: parseFloat(document.getElementById('precio').value)
                };

                const cantidad = document.getElementById('cantidad').value;
                if (cantidad) formData.cantidad = parseInt(cantidad);

                const caracteristicas = document.getElementById('caracteristicas').value.trim();
                if (caracteristicas) formData.caracteristicas = caracteristicas;

                const response = await fetch(`http://localhost:5000/api/productos/${productoId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    showSuccessMessage();
                    currentProducto = { ...currentProducto, ...formData };
                    
                    setTimeout(() => {
                        window.location.href = 'tienda.html';
                    }, 2000);
                } else {
                    alert(`Error al actualizar: ${result.error}`);
                }

            } catch (error) {
                console.error('Error actualizando:', error);
                alert('Error al conectar con el servidor');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        function validateForm() {
            let isValid = true;
            
            const nombre = document.getElementById('nombre');
            nombre.classList.remove('is-invalid');
            if (!nombre.value.trim()) {
                nombre.classList.add('is-invalid');
                isValid = false;
            }

            const precio = document.getElementById('precio');
            precio.classList.remove('is-invalid');
            if (!precio.value || parseFloat(precio.value) <= 0) {
                precio.classList.add('is-invalid');
                isValid = false;
            }

            const cantidad = document.getElementById('cantidad');
            cantidad.classList.remove('is-invalid');
            if (cantidad.value && parseInt(cantidad.value) < 0) {
                cantidad.classList.add('is-invalid');
                isValid = false;
            }

            return isValid;
        }

        function showSuccessMessage() {
            const successMsg = document.getElementById('successMessage');
            successMsg.style.display = 'block';
            successMsg.scrollIntoView({ behavior: 'smooth' });
        }

        function cancelarEdicion() {
            if (confirm('¬øSeguro que deseas cancelar? Los cambios no guardados se perder√°n.')) {
                history.back();
            }
        }

        function retryLoad() {
            if (productoId) {
                loadProductoForEdit(productoId);
            }
        }

        function showLoading(show) {
            document.getElementById('loadingEdit').style.display = show ? 'block' : 'none';
            document.getElementById('editContent').style.display = show ? 'none' : 'block';
            document.getElementById('errorEdit').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('errorEditMessage').textContent = message;
            document.getElementById('loadingEdit').style.display = 'none';
            document.getElementById('editContent').style.display = 'none';
            document.getElementById('errorEdit').style.display = 'block';
        }

        function showContent() {
            document.getElementById('loadingEdit').style.display = 'none';
            document.getElementById('errorEdit').style.display = 'none';
            document.getElementById('editContent').style.display = 'block';
        }
    </script>
</body>
</html>