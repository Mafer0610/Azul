<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Ni√±o</title>
    <link rel="stylesheet" href="../styles/stylesEditarN.css" />
    <script>
        (function() {
            function checkAuth() {
                const isAuthenticated = localStorage.getItem('isAuthenticated');
                const loginTimestamp = localStorage.getItem('loginTimestamp');
                
                if (!isAuthenticated || isAuthenticated !== 'true') {
                    redirectToLogin();
                    return;
                }
                
                if (loginTimestamp) {
                    const currentTime = Date.now();
                    const loginTime = parseInt(loginTimestamp);
                    const eightHours = 8 * 60 * 60 * 1000;
                    
                    if (currentTime - loginTime > eightHours) {
                        localStorage.removeItem('isAuthenticated');
                        localStorage.removeItem('loginTimestamp');
                        alert('Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.');
                        redirectToLogin();
                        return;
                    }
                }
            }
            
            function redirectToLogin() {
                if (window.location.pathname.includes('index.html') || 
                    window.location.pathname === '/' || 
                    window.location.pathname.endsWith('/')) {
                    return;
                }
                
                window.location.replace('../index.html');
            }
            
            checkAuth();
            
            window.addEventListener('focus', checkAuth);
            
            setInterval(checkAuth, 5 * 60 * 1000);
        })();
    </script>
</head>
<body>
    <div class="container">
        <div class="edit-container">
            <div class="edit-header">
                <h1>Editar Informaci√≥n</h1>
                <p>Modifica los datos del ni√±o registrado</p>
            </div>

            <div id="loadingEdit" class="loading-edit">
                <div class="loading-spinner" style="margin: 0 auto 15px;"></div>
                <p>Cargando informaci√≥n para editar...</p>
            </div>

            <div id="errorEdit" class="error-edit" style="display: none;">
                <h3>Error</h3>
                <p id="errorEditMessage">No se pudo cargar la informaci√≥n</p>
                <button class="btn btn-primary" onclick="retryLoad()">
                    Reintentar
                </button>
            </div>

            <div id="editContent" style="display: none;">
                <form class="edit-form" id="editForm">
                    <a href="javascript:history.back()" class="back-link">
                        ‚Üê Volver a detalles
                    </a>

                    <div class="success-message" id="successMessage">
                        La informaci√≥n se actualiz√≥ correctamente
                    </div>

                    <h3 style="color: #495057; margin-bottom: 20px; border-bottom: 2px solid #ffc107; padding-bottom: 10px;">
                        üë§ Informaci√≥n Personal
                    </h3>

                    <div class="form-group">
                        <label class="form-label" for="nombreCompleto">Nombre Completo *</label>
                        <input type="text" class="form-control" id="nombreCompleto" name="nombreCompleto" required>
                        <div class="invalid-feedback">El nombre completo es obligatorio</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="fechaNacimiento">Fecha de Nacimiento *</label>
                        <input type="date" class="form-control" id="fechaNacimiento" name="fechaNacimiento" required>
                        <div class="invalid-feedback">La fecha de nacimiento es obligatoria</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="edad">Edad</label>
                        <input type="text" class="form-control" id="edad" name="edad" readonly placeholder="Se calcula autom√°ticamente">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="comportamiento">Diagn√≥stico *</label>
                        <select class="form-control form-select" id="comportamiento" name="comportamiento" required>
                            <option value="">Seleccionar diagn√≥stico</option>
                            <option value="neurotipico">Neurot√≠pico</option>
                            <option value="neurodivergente">Neurodivergente</option>
                        </select>
                        <div class="invalid-feedback">Selecciona un tipo de diagn√≥stico</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="tipoSangre">Tipo de Sangre *</label>
                        <select class="form-control form-select" id="tipoSangre" name="tipoSangre" required>
                            <option value="">Seleccionar tipo</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                        <div class="invalid-feedback">Selecciona el tipo de sangre</div>
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label class="form-label">Servicios *</label>
                        <div class="servicios-container-edit">
                            <div class="checkbox-option-edit">
                                <input type="checkbox" id="edit-natacion" name="servicios" value="Nataci√≥n">
                                <label for="edit-natacion">Nataci√≥n</label>
                            </div>
                            <div class="checkbox-option-edit">
                                <input type="checkbox" id="edit-estimulacion" name="servicios" value="Estimulaci√≥n">
                                <label for="edit-estimulacion">Estimulaci√≥n</label>
                            </div>
                            <div class="checkbox-option-edit">
                                <input type="checkbox" id="edit-baby-spa" name="servicios" value="Baby Spa">
                                <label for="edit-baby-spa">Baby Spa</label>
                            </div>
                            <div class="checkbox-option-edit">
                                <input type="checkbox" id="edit-acuatica-inicial" name="servicios" value="Paquete de Acu√°tica Inicial">
                                <label for="edit-acuatica-inicial">Paquete de Acu√°tica Inicial</label>
                            </div>
                            <div class="checkbox-option-edit">
                                <input type="checkbox" id="edit-estimulacion-temprana" name="servicios" value="Estimulaci√≥n temprana">
                                <label for="edit-estimulacion-temprana">Estimulaci√≥n temprana</label>
                            </div>
                        </div>
                        <div class="invalid-feedback">Selecciona al menos un servicio</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="caracteristicas">Caracter√≠sticas Especiales</label>
                        <textarea class="form-control" id="caracteristicas" name="caracteristicas" rows="4" 
                                  placeholder="Describe caracter√≠sticas especiales, necesidades, etc. (opcional)"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="alergias">Alergias</label>
                        <textarea class="form-control" id="alergias" name="alergias" rows="3" 
                                  placeholder="Describe alergias conocidas (opcional)"></textarea>
                    </div>

                    <h3 style="color: #495057; margin: 30px 0 20px 0; border-bottom: 2px solid #ffc107; padding-bottom: 10px;">
                        üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Informaci√≥n del Tutor
                    </h3>

                    <div class="form-group">
                        <label class="form-label" for="nombreTutor">Nombre del Tutor *</label>
                        <input type="text" class="form-control" id="nombreTutor" name="nombreTutor" required>
                        <div class="invalid-feedback">El nombre del tutor es obligatorio</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="celularTutor">Celular del Tutor *</label>
                        <input type="tel" class="form-control" id="celularTutor" name="celularTutor" 
                               pattern="[0-9]{10}" maxlength="10" 
                               placeholder="Ej: 9611234567" required>
                        <div class="invalid-feedback">El celular debe tener exactamente 10 d√≠gitos</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="correoTutor">Correo del Tutor *</label>
                        <input type="email" class="form-control" id="correoTutor" name="correoTutor" 
                               placeholder="ejemplo@email.com" required>
                        <div class="invalid-feedback">El correo electr√≥nico es obligatorio y debe ser v√°lido</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="fechaPago">Fecha de Pago *</label>
                        <select class="form-control form-select" id="fechaPago" name="fechaPago" required>
                            <option value="">Seleccionar d√≠a del mes</option>
                            <option value="1">D√≠a 1</option>
                            <option value="2">D√≠a 2</option>
                            <option value="3">D√≠a 3</option>
                            <option value="4">D√≠a 4</option>
                            <option value="5">D√≠a 5</option>
                            <option value="6">D√≠a 6</option>
                            <option value="7">D√≠a 7</option>
                            <option value="8">D√≠a 8</option>
                            <option value="9">D√≠a 9</option>
                            <option value="10">D√≠a 10</option>
                            <option value="11">D√≠a 11</option>
                            <option value="12">D√≠a 12</option>
                            <option value="13">D√≠a 13</option>
                            <option value="14">D√≠a 14</option>
                            <option value="15">D√≠a 15</option>
                            <option value="16">D√≠a 16</option>
                            <option value="17">D√≠a 17</option>
                            <option value="18">D√≠a 18</option>
                            <option value="19">D√≠a 19</option>
                            <option value="20">D√≠a 20</option>
                            <option value="21">D√≠a 21</option>
                            <option value="22">D√≠a 22</option>
                            <option value="23">D√≠a 23</option>
                            <option value="24">D√≠a 24</option>
                            <option value="25">D√≠a 25</option>
                            <option value="26">D√≠a 26</option>
                            <option value="27">D√≠a 27</option>
                            <option value="28">D√≠a 28</option>
                            <option value="29">D√≠a 29</option>
                            <option value="30">D√≠a 30</option>
                            <option value="31">D√≠a 31</option>
                        </select>
                        <div class="invalid-feedback">Selecciona el d√≠a de pago mensual</div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="cancelarEdicion()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-warning" id="submitBtn">
                            Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentPeque = null;
        let pequeId = null;

        function calcularEdad(fechaNacimiento) {
            const hoy = new Date();
            const nacimiento = new Date(fechaNacimiento);
            let edad = hoy.getFullYear() - nacimiento.getFullYear();
            const mes = hoy.getMonth() - nacimiento.getMonth();
            
            if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
                edad--;
            }
            
            if (edad === 0) {
                let meses = mes;
                if (hoy.getDate() < nacimiento.getDate()) {
                    meses--;
                }
                if (meses <= 0) {
                    meses = 12 + meses;
                }
                return `${Math.max(meses, 1)} meses`;
            } else {
                return `${edad} a√±os`;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            pequeId = urlParams.get('id');
            
            if (pequeId) {
                loadPequeForEdit(pequeId);
            } else {
                showError('No se especific√≥ un ID de ni√±o v√°lido');
            }

            document.getElementById('editForm').addEventListener('submit', handleSubmit);
            
            document.getElementById('celularTutor').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '').substring(0, 10);
            });

            document.getElementById('fechaNacimiento').addEventListener('change', function(e) {
                const fechaNacimiento = e.target.value;
                if (fechaNacimiento) {
                    const edad = calcularEdad(fechaNacimiento);
                    document.getElementById('edad').value = edad;
                }
            });
        });

        async function loadPequeForEdit(id) {
            showLoading(true);
            
            try {
                const response = await fetch(`http://localhost:5000/api/peques/${id}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('El ni√±o solicitado no fue encontrado');
                    }
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const peque = await response.json();
                currentPeque = peque;
                fillForm(peque);
                showContent();
                
            } catch (error) {
                console.error('Error cargando datos para edici√≥n:', error);
                showError(error.message);
            }
        }

        function fillForm(peque) {
            document.getElementById('nombreCompleto').value = peque.nombreCompleto || '';
            
            // Formatear fecha de nacimiento para el input date
            if (peque.fechaNacimiento) {
                const fecha = new Date(peque.fechaNacimiento);
                const fechaFormatted = fecha.toISOString().split('T')[0];
                document.getElementById('fechaNacimiento').value = fechaFormatted;
            }
            
            document.getElementById('edad').value = peque.edad || '';
            document.getElementById('comportamiento').value = peque.comportamiento || '';
            document.getElementById('tipoSangre').value = peque.tipoSangre || '';
            
            // Marcar servicios seleccionados
            if (peque.servicios && Array.isArray(peque.servicios)) {
                const checkboxes = document.querySelectorAll('input[name="servicios"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = peque.servicios.includes(checkbox.value);
                });
            } else if (peque.servicio) {
                // Compatibilidad con el campo antiguo
                const checkbox = document.querySelector(`input[name="servicios"][value="${peque.servicio}"]`);
                if (checkbox) checkbox.checked = true;
            }
            
            document.getElementById('caracteristicas').value = peque.caracteristicas || '';
            document.getElementById('alergias').value = peque.alergias || '';
            document.getElementById('nombreTutor').value = peque.nombreTutor || '';
            document.getElementById('celularTutor').value = peque.celularTutor || '';
            document.getElementById('correoTutor').value = peque.correoTutor || '';
            document.getElementById('fechaPago').value = peque.fechaPago || '';

            document.title = `Editar - ${peque.nombreCompleto}`;
        }

        async function handleSubmit(event) {
            event.preventDefault();
            
            if (!validateForm()) {
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Guardando...';

            try {
                // Obtener servicios seleccionados
                const serviciosSeleccionados = [];
                const checkboxes = document.querySelectorAll('input[name="servicios"]:checked');
                checkboxes.forEach(checkbox => {
                    serviciosSeleccionados.push(checkbox.value);
                });

                const formData = {
                    nombreCompleto: document.getElementById('nombreCompleto').value.trim(),
                    fechaNacimiento: document.getElementById('fechaNacimiento').value,
                    comportamiento: document.getElementById('comportamiento').value,
                    tipoSangre: document.getElementById('tipoSangre').value.trim,
                    servicios: serviciosSeleccionados, 
                    caracteristicas: document.getElementById('caracteristicas').value.trim(),
                    alergias: document.getElementById('alergias').value.trim(),
                    nombreTutor: document.getElementById('nombreTutor').value.trim(),
                    celularTutor: document.getElementById('celularTutor').value.trim(),
                    correoTutor: document.getElementById('correoTutor').value.trim(),
                    fechaPago: parseInt(document.getElementById('fechaPago').value)
                };

                const response = await fetch(`http://localhost:5000/api/peques/${pequeId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    showSuccessMessage();
                    currentPeque = { ...currentPeque, ...formData };
                    
                    setTimeout(() => {
                        window.location.href = `verN.html?id=${pequeId}`;
                    }, 2000);
                } else {
                    alert(`Error al actualizar: ${result.error}`);
                }

            } catch (error) {
                console.error('Error actualizando:', error);
                alert('Error al conectar con el servidor');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        function validateForm() {
            let isValid = true;
            const fields = ['nombreCompleto', 'fechaNacimiento', 'comportamiento', 'tipoSangre', 'nombreTutor', 'celularTutor', 'correoTutor', 'fechaPago'];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.classList.remove('is-invalid');
            });

            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                }
            });

            // Validar servicios
            const serviciosSeleccionados = document.querySelectorAll('input[name="servicios"]:checked');
            const serviciosContainer = document.querySelector('.servicios-container-edit');
            if (serviciosSeleccionados.length === 0) {
                serviciosContainer.classList.add('is-invalid');
                isValid = false;
            } else {
                serviciosContainer.classList.remove('is-invalid');
            }

            const celular = document.getElementById('celularTutor');
            if (celular.value && celular.value.length !== 10) {
                celular.classList.add('is-invalid');
                isValid = false;
            }

            const correo = document.getElementById('correoTutor');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (correo.value && !emailRegex.test(correo.value)) {
                correo.classList.add('is-invalid');
                isValid = false;
            }

            return isValid;
        }

        function showSuccessMessage() {
            const successMsg = document.getElementById('successMessage');
            successMsg.style.display = 'block';
            successMsg.scrollIntoView({ behavior: 'smooth' });
        }

        function cancelarEdicion() {
            if (confirm('¬øSeguro que deseas cancelar? Los cambios no guardados se perder√°n.')) {
                history.back();
            }
        }

        function retryLoad() {
            if (pequeId) {
                loadPequeForEdit(pequeId);
            }
        }

        function showLoading(show) {
            document.getElementById('loadingEdit').style.display = show ? 'block' : 'none';
            document.getElementById('editContent').style.display = show ? 'none' : 'block';
            document.getElementById('errorEdit').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('errorEditMessage').textContent = message;
            document.getElementById('loadingEdit').style.display = 'none';
            document.getElementById('editContent').style.display = 'none';
            document.getElementById('errorEdit').style.display = 'block';
        }

        function showContent() {
            document.getElementById('loadingEdit').style.display = 'none';
            document.getElementById('errorEdit').style.display = 'none';
            document.getElementById('editContent').style.display = 'block';
        }
    </script>
</body>
</html>